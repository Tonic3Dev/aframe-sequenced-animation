<head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script>
        AFRAME.registerComponent('play-on-load', {
            init: function () {
                var el = this.el;
                var modelsLoaded = 0;
                var totalModels = 0;
                // Get all the models in the scene
                el.sceneEl.querySelectorAll('a-gltf-model').forEach(function (modelEl) {
                    totalModels++;
                    modelEl.addEventListener('model-loaded', async function (e) {
                        const _anim = await document.getElementById('cr_animation').object3D.children[0];
                        const _object = await this.getObject3D('mesh');
                        modelsLoaded++;
                        // If all the models have loaded
                        if (modelsLoaded === totalModels) {
                            // Character Model
                            var mesh = await el.getObject3D('mesh');
                            if (!mesh) { return; }
                            // Create Animation Mixer for the Character Model
                            var mixer = await new THREE.AnimationMixer(mesh);
                            // Making sure we don't run twice
                            if (!_object.animations.length) {
                                await _anim.animations.map(async (_track, _i) => {
                                    // Push animations to the file structure
                                    await _object.animations.push(_track);
                                    // Push animations to the mixer as well
                                    await mixer.clipAction(_anim.animations[_i].name, mesh);
                                });
                            }
                            // Play the first or only animation
                            el.setAttribute('animation-mixer', 'clip: ' + mixer._actions[4]._clip.name);
                        }
                    });
                });
            }
        });
    </script>
</head>

<body>
    <a-scene id="scene">
        <a-assets>
            <a-asset-item id="cr_model_fox" src="models/fox_without_NLAtracks.glb"
                crossorigin="anonymous"></a-asset-item>
            <a-asset-item id="cr_animations_legacy" src="models/armature_with_NLAtracks.glb"
                crossorigin="anonymous"></a-asset-item>
            <a-asset-item id="sign_model" src="https://assets.codepen.io/8724203/pr_poster_model.glb"
                crossorigin="anonymous"></a-asset-item>
        </a-assets>
        <a-gltf-model id="cr_model" position="0 0 -8" gltf-model="#cr_model_fox" play-on-load></a-gltf-model>
        <a-gltf-model id="cr_animation" position="0 20 0" gltf-model="#cr_animations_legacy"
            animation-mixer></a-gltf-model>
        <a-gltf-model id="sign" position="1.5251 0 -8.19441" gltf-model="#sign_model" animation-mixer></a-gltf-model>
        <a-plane position="0 0 -5" rotation="-90 0 0" width="4" height="4" color="#ff0000"></a-plane>
        <a-sky color="#ECECEC"></a-sky>
        <a-camera id="camera"></a-camera>
    </a-scene>
</body>
